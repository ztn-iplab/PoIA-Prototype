{% extends "base.html" %}
{% block content %}
<section class="panel auth-card auth-shell">
  <h1>Create a new password</h1>
  <p class="note">Verify with TOTP and set a strong password to finish your reset.</p>
  {% if error %}<p class="warn">{{ error }}</p>{% endif %}
  <form class="form" method="post" action="/reset-password">
    <input type="hidden" name="token" value="{{ token }}" />
    <label>
      TOTP code
      <input type="text" name="otp" inputmode="numeric" />
    </label>
    <label>
      New password
      <input type="password" name="password" required />
    </label>
    <label>
      Confirm password
      <input type="password" name="confirm_password" required />
    </label>
    <button class="primary" type="submit">Reset password</button>
  </form>
  <div class="note">
    <button id="passkey-reset" class="ghost" type="button">Use passkey instead</button>
  </div>
</section>
<script>
  async function bufferDecode(value) {
    return Uint8Array.from(atob(value.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0));
  }
  async function bufferEncode(value) {
    return btoa(String.fromCharCode(...new Uint8Array(value)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  const resetBtn = document.getElementById('passkey-reset');
  resetBtn?.addEventListener('click', async () => {
    const token = document.querySelector('input[name="token"]').value;
    const beginRes = await fetch('/webauthn/reset-password-begin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token }),
    });
    const beginData = await beginRes.json();
    if (!beginRes.ok) {
      alert(beginData.error || 'Passkey reset failed.');
      return;
    }
    const publicKey = beginData.public_key;
    publicKey.challenge = await bufferDecode(publicKey.challenge);
    if (publicKey.allowCredentials) {
      publicKey.allowCredentials = publicKey.allowCredentials.map(cred => ({
        ...cred,
        id: bufferDecode(cred.id),
      }));
    }
    const assertion = await navigator.credentials.get({ publicKey });
    const authData = {
      credentialId: await bufferEncode(assertion.rawId),
      clientDataJSON: await bufferEncode(assertion.response.clientDataJSON),
      authenticatorData: await bufferEncode(assertion.response.authenticatorData),
      signature: await bufferEncode(assertion.response.signature),
      userHandle: assertion.response.userHandle ? await bufferEncode(assertion.response.userHandle) : null,
    };
    const completeRes = await fetch('/webauthn/reset-complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(authData),
    });
    if (!completeRes.ok) {
      const completeData = await completeRes.json();
      alert(completeData.error || 'Passkey reset failed.');
      return;
    }
    alert('Passkey verified. You can submit the new password now.');
  });
</script>
{% endblock %}
