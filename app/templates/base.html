<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PoIA Banking Demo</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
  </head>
  <body>
    {% if poia_intent_id %}
      <div class="poia-backdrop" data-intent="{{ poia_intent_id }}" data-user="{{ user_id or '' }}" data-zt-enabled="{{ 1 if user and user['poia_zt_enabled'] else 0 }}" data-admin="{{ 1 if user and user['is_admin'] else 0 }}">
        <div class="poia-modal">
          <h2>Authorize intent</h2>
          <p class="note">Confirm the exact action below. Tap the panel to approve with your passkey.</p>
          <div class="intent">
            <div id="poia-summary">Loading intent...</div>
          </div>
          <div class="meta">
            <div><strong>Expires in:</strong> <span id="poia-expiry">-</span></div>
          </div>
          <div class="actions">
            <a
              class="ghost"
              id="poia-cancel"
              href="{{ '/admin/dashboard' if user and user['is_admin'] else '/dashboard' }}"
            >Cancel</a>
          </div>
          <p id="poia-status" class="note">Passkey approval is ready.</p>
        </div>
      </div>
    {% endif %}
    <header class="site-header">
      {% if user %}
        {% if user["is_admin"] %}
          <a class="brand" href="/admin/dashboard">PoIA Bank</a>
        {% else %}
          <a class="brand" href="/dashboard">PoIA Bank</a>
        {% endif %}
      {% else %}
        <a class="brand" href="/">PoIA Bank</a>
      {% endif %}
      <nav class="nav">
        {% if user %}
          {% if user["is_admin"] %}
            <a href="/admin/dashboard">Admin</a>
            <a href="/admin/audit">Audit</a>
            <a href="/admin/mfa">MFA Metrics</a>
            <a href="/profile">Profile</a>
            <a href="/settings">Settings</a>
          {% else %}
            <a href="/dashboard">Dashboard</a>
            <a href="/profile">Profile</a>
            <a href="/settings">Settings</a>
            <a href="/transfer">Transfer</a>
            <a href="/beneficiaries">Beneficiaries</a>
            <a href="/cash">Cash</a>
            <a href="/statements">Statements</a>
          {% endif %}
          <a href="/logout">Logout</a>
        {% else %}
          <a href="/login">Login</a>
          <a href="/signup">Sign up</a>
        {% endif %}
      </nav>
    </header>
    <main class="content">
      {% block content %}{% endblock %}
    </main>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    {% if flash_message %}
      <script>
        Toastify({
          text: "{{ flash_message }}",
          duration: 4200,
          gravity: "top",
          position: "right",
          close: true,
          stopOnFocus: true,
          style: {
            background: "linear-gradient(135deg, #1f2a4f, #2c4a7a)",
          },
        }).showToast();
      </script>
    {% endif %}
    {% if poia_intent_id %}
      <script>
        const poiaBackdrop = document.querySelector('.poia-backdrop');
        const poiaStatus = document.getElementById('poia-status');
        const poiaSummary = document.getElementById('poia-summary');
        const poiaExpiry = document.getElementById('poia-expiry');
        const poiaPasskey = document.getElementById('poia-passkey');
        const poiaDevice = document.getElementById('poia-device');
        const poiaModal = document.querySelector('.poia-modal');
        const poiaCancel = document.getElementById('poia-cancel');
        let passkeyTriggered = false;
        let autoPasskeyArmed = true;
        let approvalInFlight = false;
        let approvalComplete = false;
        let poiaPublicKey = null;

        function showToast(message, ok = true) {
          if (typeof Toastify !== 'function') {
            return;
          }
          Toastify({
            text: message,
            duration: 4000,
            gravity: "top",
            position: "right",
            close: true,
            stopOnFocus: true,
            style: {
              background: ok
                ? "linear-gradient(135deg, #1f5b4f, #2d8a6e)"
                : "linear-gradient(135deg, #7a2c2c, #a94442)",
            },
          }).showToast();
        }
        let poiaIntentData = null;
        const intentId = poiaBackdrop ? poiaBackdrop.dataset.intent : '';
        const userId = poiaBackdrop ? poiaBackdrop.dataset.user : '';
        const ztEnabled = poiaBackdrop ? poiaBackdrop.dataset.ztEnabled === '1' : false;
        const isAdmin = poiaBackdrop ? poiaBackdrop.dataset.admin === '1' : false;
        const poiaScenario = new URLSearchParams(window.location.search).get('scenario') || '';

        function sendPoiaTelemetry(event, extra = {}) {
          if (!intentId) {
            return;
          }
          const payload = {
            event,
            intent_id: intentId,
            user_id: userId || null,
            rp_id: poiaIntentData?.context?.rp_id || null,
            method: ztEnabled ? 'zt_authenticator' : 'webauthn',
            scenario: poiaScenario,
            client_ts: Date.now() / 1000,
            ...extra,
          };
          fetch('/api/poia/telemetry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload),
          }).catch(() => {});
        }

        function base64urlToBuffer(value) {
          const base64 = value.replace(/-/g, '+').replace(/_/g, '/');
          const pad = base64.length % 4 ? '='.repeat(4 - (base64.length % 4)) : '';
          const binary = atob(base64 + pad);
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          return bytes.buffer;
        }

        function bufferToBase64url(buffer) {
          const bytes = new Uint8Array(buffer);
          let str = '';
          for (const byte of bytes) {
            str += String.fromCharCode(byte);
          }
          return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function formatCurrency(amount, currency) {
          const safeAmount = Number(amount || 0);
          try {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency || 'USD' }).format(safeAmount);
          } catch (err) {
            return `${safeAmount.toFixed(2)} ${currency || 'USD'}`;
          }
        }

        function renderIntent(intent) {
          if (!intent) {
            poiaSummary.textContent = 'Unable to load intent.';
            return;
          }
          const action = intent.action;
          const scope = intent.scope || {};
          const context = intent.context || {};
          let title = 'Authorize action';
          let lines = [];
          if (action === 'transfer') {
            title = `Transfer ${formatCurrency(scope.amount, scope.currency)}`;
            lines.push(`From account #${scope.from_account}`);
            if (scope.beneficiary_id) {
              lines.push(`To beneficiary #${scope.beneficiary_id}`);
            } else if (scope.external_account) {
              lines.push(`To external account ${scope.external_account}`);
            }
          } else if (action === 'withdrawal') {
            title = `Withdraw ${formatCurrency(scope.amount, scope.currency)}`;
            lines.push(`From account #${scope.account_id}`);
          } else if (action === 'deposit') {
            title = `Deposit ${formatCurrency(scope.amount, scope.currency)}`;
            lines.push(`To account #${scope.account_id}`);
          } else if (action === 'beneficiary_add') {
            title = 'Add beneficiary';
            lines.push(`Name: ${scope.name}`);
            lines.push(`Bank: ${scope.bank}`);
            lines.push(`Account: ${scope.account_number}`);
          } else if (action === 'statement_export') {
            title = 'Export statements';
            if (scope.account_id) lines.push(`Account filter: ${scope.account_id}`);
            if (scope.txn_type) lines.push(`Type: ${scope.txn_type}`);
            if (scope.date_from) lines.push(`From: ${scope.date_from}`);
            if (scope.date_to) lines.push(`To: ${scope.date_to}`);
          } else if (action === 'admin_audit_view') {
            title = 'View audit log';
          } else if (action === 'admin_mfa_view') {
            title = 'View MFA metrics';
          }
          if (context.rp_id) {
            lines.push(`Relying party: ${context.rp_id}`);
          }
          const html = [
            `<strong>${title}</strong>`,
            '<ul>' + lines.map(item => `<li>${item}</li>`).join('') + '</ul>',
          ].join('');
          poiaSummary.innerHTML = html;
        }

        function handleApprovedRedirect(redirectUrl = '') {
          approvalComplete = true;
          approvalInFlight = false;
          if (countdownTimer) {
            clearInterval(countdownTimer);
          }
          poiaBackdrop?.classList.add('poia-hidden');
          const action = poiaIntentData?.action;
          if (action === 'statement_export') {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = `/poia/execute/${intentId}`;
            document.body.appendChild(iframe);
            setTimeout(() => {
              window.location.href = '/statements';
            }, 900);
            return;
          }
          const destination = redirectUrl || `/poia/execute/${intentId}`;
          window.location.href = destination;
        }

        if (poiaCancel) {
          poiaCancel.addEventListener('click', async (event) => {
            event.preventDefault();
            if (intentId) {
              await fetch('/api/poia/deny', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ intent_id: intentId, reason: 'user_cancelled' }),
              }).catch(() => {});
            }
            const target = isAdmin ? '/admin/dashboard' : '/dashboard';
            window.location.href = target;
          });
        }

        async function loadIntent() {
          poiaPasskey?.setAttribute('disabled', 'true');
          const res = await fetch(`/poia/intent/${intentId}`, { credentials: 'include' });
          const data = await res.json();
          if (!res.ok) {
            poiaStatus.textContent = data.error || 'Unable to load intent.';
            poiaStatus.style.color = '#c24b41';
            return;
          }
          poiaIntentData = data.intent;
          renderIntent(poiaIntentData);
          sendPoiaTelemetry('intent_loaded');
          const expiresAt = data.expires_at;
          const updateCountdown = () => {
            const remaining = Math.max(0, expiresAt - Math.floor(Date.now() / 1000));
            poiaExpiry.textContent = `${remaining}s`;
            if (remaining === 0) {
              handleExpiry();
            }
          };
          if (ztEnabled) {
            poiaStatus.textContent = 'Waiting for ZT-Authenticator approval...';
            poiaStatus.style.color = '#2c2c2c';
            updateCountdown();
            countdownTimer = setInterval(updateCountdown, 1000);
            sendPoiaTelemetry('zt_auto_start');
            startDeviceApproval();
          } else {
            poiaPublicKey = await preparePasskey();
            if (poiaPublicKey) {
              poiaStatus.textContent = 'Tap the intent panel to approve with passkey.';
              poiaStatus.style.color = '#2c2c2c';
            }
          }
          poiaModal?.addEventListener('click', () => {
            if (countdownTimer || approvalComplete) {
              return;
            }
            updateCountdown();
            countdownTimer = setInterval(updateCountdown, 1000);
          }, { once: true });
        }

        async function preparePasskey() {
          const beginRes = await fetch('/poia/assertion-begin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ intent_id: intentId }),
          });
          const beginData = await beginRes.json();
          if (!beginRes.ok) {
            poiaStatus.textContent = beginData.detail || beginData.error || 'Unable to start passkey approval.';
            poiaStatus.style.color = '#c24b41';
            return null;
          }
          const publicKey = beginData.public_key;
          publicKey.challenge = base64urlToBuffer(publicKey.challenge);
          if (publicKey.allowCredentials) {
            publicKey.allowCredentials = publicKey.allowCredentials.map(cred => ({
              ...cred,
              id: base64urlToBuffer(cred.id),
            }));
          }
          return publicKey;
        }

        async function startPasskey() {
          if (approvalInFlight || approvalComplete) {
            return;
          }
          approvalInFlight = true;
          poiaStatus.textContent = 'Waiting for passkey...';
          if (!poiaPublicKey) {
            poiaStatus.textContent = 'Preparing passkey prompt. Please try again in a moment.';
            poiaStatus.style.color = '#c24b41';
            approvalInFlight = false;
            return;
          }
          let assertion;
          try {
            assertion = await navigator.credentials.get({ publicKey: poiaPublicKey });
          } catch (err) {
            poiaStatus.textContent = 'Passkey prompt blocked. Tap the intent panel to try again.';
            poiaStatus.style.color = '#c24b41';
            sendPoiaTelemetry('passkey_blocked');
            approvalInFlight = false;
            return;
          }
          poiaStatus.textContent = 'Verifying approval...';
          poiaStatus.style.color = '#2c2c2c';
          sendPoiaTelemetry('passkey_assertion');
          const payload = {
            credentialId: bufferToBase64url(assertion.rawId),
            clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
            authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
            signature: bufferToBase64url(assertion.response.signature),
            userHandle: assertion.response.userHandle ? bufferToBase64url(assertion.response.userHandle) : null,
          };
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            const completePromise = fetch('/poia/assertion-complete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload),
              signal: controller.signal,
            });
            // Poll for approval in parallel in case the response is delayed.
            pollDevice();
            const completeRes = await completePromise;
            clearTimeout(timeoutId);
            if (!completeRes.ok) {
              const text = await completeRes.text();
              poiaStatus.textContent = text ? `PoIA approval failed: ${text.slice(0, 200)}` : 'PoIA approval failed.';
              poiaStatus.style.color = '#c24b41';
              showToast('Approval failed. Please try again.', false);
              sendPoiaTelemetry('approval_failed', { status: 'denied' });
              approvalInFlight = false;
              return;
            }
            const contentType = completeRes.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
              const data = await completeRes.json();
              if (data.redirect_url) {
                poiaStatus.textContent = 'Approval recorded. Completing action...';
                poiaStatus.style.color = '#2c2c2c';
                showToast('Approval confirmed. Completing action...', true);
                sendPoiaTelemetry('approval_success', { status: 'approved' });
                handleApprovedRedirect(data.redirect_url);
                return;
              }
            }
            poiaStatus.textContent = 'Approval recorded. Completing action...';
            poiaStatus.style.color = '#2c2c2c';
            showToast('Approval confirmed. Completing action...', true);
            sendPoiaTelemetry('approval_success', { status: 'approved' });
            handleApprovedRedirect();
          } catch (err) {
            poiaStatus.textContent = 'Approval timed out. Tap the panel to retry.';
            poiaStatus.style.color = '#c24b41';
            showToast('Approval timed out. Tap the panel to retry.', false);
            sendPoiaTelemetry('approval_timeout', { status: 'timeout' });
            approvalInFlight = false;
          }
        }

        async function pollDevice() {
          const res = await fetch(`/poia/status?intent_id=${encodeURIComponent(intentId)}`, { credentials: 'include' });
          const data = await res.json();
          if (data.status === 'approved') {
            sendPoiaTelemetry('zt_status_approved', { status: 'approved' });
            handleApprovedRedirect();
            return;
          }
          if (data.status === 'denied') {
            poiaStatus.textContent = 'Approval denied.';
            poiaStatus.style.color = '#c24b41';
            approvalComplete = true;
            poiaBackdrop?.classList.add('poia-hidden');
            if (countdownTimer) {
              clearInterval(countdownTimer);
            }
            sendPoiaTelemetry('zt_status_denied', { status: 'denied' });
            setTimeout(() => {
              const target = isAdmin ? '/admin/dashboard' : '/dashboard';
              window.location.href = target;
            }, 700);
            return;
          }
          if (data.status === 'expired') {
            poiaStatus.textContent = 'Intent expired.';
            poiaStatus.style.color = '#c24b41';
            approvalComplete = true;
            if (countdownTimer) {
              clearInterval(countdownTimer);
            }
            sendPoiaTelemetry('zt_status_expired', { status: 'expired' });
            setTimeout(() => {
              const target = isAdmin ? '/admin/dashboard' : '/dashboard';
              window.location.href = target;
            }, 700);
            return;
          }
          setTimeout(pollDevice, 1500);
        }

        async function startDeviceApproval() {
          if (approvalInFlight || approvalComplete) {
            return;
          }
          approvalInFlight = true;
          poiaStatus.textContent = 'Waiting for ZT-Authenticator approval...';
          poiaStatus.style.color = '#2c2c2c';
          if (userId) {
            const pendingRes = await fetch(`/api/poia/pending?user_id=${encodeURIComponent(userId)}&force=1`, { credentials: 'include' });
            if (pendingRes.ok) {
              const pendingData = await pendingRes.json();
              if (pendingData.status === 'disabled') {
                approvalInFlight = false;
                poiaStatus.textContent = 'ZT-Authenticator is disabled. Tap to approve with passkey.';
                poiaStatus.style.color = '#2c2c2c';
                if (!poiaPublicKey) {
                  poiaPublicKey = await preparePasskey();
                }
                return;
              }
            }
          }
          pollDevice();
        }

        loadIntent();
        poiaStatus.style.color = '#2c2c2c';
        poiaModal?.addEventListener('click', (event) => {
          if (passkeyTriggered) {
            return;
          }
          if (event.target.closest('a')) {
            return;
          }
          if (ztEnabled) {
            passkeyTriggered = true;
            autoPasskeyArmed = false;
            startDeviceApproval();
            return;
          }
          if (!poiaPublicKey) {
            poiaStatus.textContent = 'Preparing passkey prompt. Please try again in a moment.';
            poiaStatus.style.color = '#c24b41';
            return;
          }
          if (!countdownTimer) {
            const expiresAt = Number(poiaModal?.dataset?.poiaExpiresAt || 0);
            if (expiresAt) {
              const updateCountdown = () => {
                const remaining = Math.max(0, expiresAt - Math.floor(Date.now() / 1000));
                poiaExpiry.textContent = `${remaining}s`;
                if (remaining === 0) {
                  handleExpiry();
                }
              };
              updateCountdown();
              countdownTimer = setInterval(updateCountdown, 1000);
            }
          }
          passkeyTriggered = true;
          autoPasskeyArmed = false;
          startPasskey();
        });

        let countdownTimer = null;
        async function handleExpiry() {
          if (countdownTimer) {
            clearInterval(countdownTimer);
          }
          if (approvalComplete) {
            return;
          }
          poiaStatus.textContent = 'Intent expired. Returning to the previous page.';
          poiaStatus.style.color = '#c24b41';
          sendPoiaTelemetry('intent_expired', { status: 'expired' });
          await fetch('/api/poia/deny', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ intent_id: intentId }),
          });
          setTimeout(() => {
            const target = isAdmin ? '/admin/dashboard' : '/dashboard';
            window.location.href = target;
          }, 1200);
        }
      </script>
    {% endif %}
  </body>
</html>
